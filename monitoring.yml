- hosts: master-01
  become: yes
  tasks:
    - name: Clone files for monitoring
      ansible.builtin.git:
        repo: https://github.com/JasperPaenen/Ansible-HA-Automation.git
        dest: /home/admin/Ansible-HA-Automation/
    - name: Kubernetes namespace
      shell: kubectl create namespace monitoring
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create cluster role
      shell: kubectl create -f clusterRole.yaml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create config-map
      shell: kubectl create -f config-map.yaml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create Prometheus deployment
      shell: kubectl create  -f prometheus-deployment.yaml 
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create Prometheus service
      shell: kubectl create -f prometheus-service.yaml --namespace=monitoring
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create grafana source
      shell: kubectl create -f grafana-datasource-config.yaml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create grafana deployment
      shell: kubectl create -f deployment.yaml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create grafana service
      shell: kubectl create -f service.yaml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Deploy Kubernetes dashboard
      shell: kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
      become_user: admin
    - name: Deploy Kubernetes dashboard
      shell: kubectl expose deployment kubernetes-dashboard -n kubernetes-dashboard --name=dashboard --type=NodePort
      become_user: admin
    - name: Create user for token
      shell: kubectl apply -f dashboard-user.yml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create cluster role ClusterRoleBinding for token
      shell: kubectl apply -f ClusterRoleBinding.yml
      become_user: admin
      args:
        chdir: /home/admin/Ansible-HA-Automation
    - name: Create token for dashboard pipe into text file
      shell: kubectl -n kubernetes-dashboard create token admin-user >> /home/admin/token.txt
      become_user: admin
    - name: Recursively remove directory
      ansible.builtin.file:
        path: /home/admin/Ansible-HA-Automation
        state: absent




    
    

    
  